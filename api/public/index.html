<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Together</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Language Selection */
        #lang-screen {
            text-align: center;
            padding-top: 20px;
        }

        .lang-group {
            margin-bottom: 25px;
            text-align: left;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .lang-group h3 {
            margin-top: 0;
            color: #555;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .radio-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .radio-item {
            position: relative;
        }

        .radio-item input {
            display: none;
        }

        .radio-item label {
            display: block;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-item input:checked+label {
            border-color: #1a73e8;
            background: #e8f0fe;
            color: #1a73e8;
            font-weight: bold;
        }

        .flag {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }

        #btn-start {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: bold;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.2s;
        }

        #btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .cat-card {
            background: white;
            border-radius: 16px;
            padding: 25px 10px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, background 0.2s;
            border: 2px solid transparent;
        }

        .cat-card:active {
            transform: scale(0.95);
            background: #f5f5f5;
        }

        .cat-card:hover {
            border-color: #1a73e8;
        }

        .cat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .cat-label {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        /* Main App */
        #app-screen {
            display: none;
        }

        .back-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        h1 {
            font-size: 22px;
            text-align: center;
            color: #1a73e8;
            margin: 0 0 20px 0;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
        }

        select,
        input,
        button.action-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .highlight-box {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }

        .target-text {
            font-size: 28px;
            font-weight: bold;
            color: #1565c0;
            margin: 0;
            word-break: keep-all;
        }

        .native-text {
            font-size: 16px;
            color: #666;
            margin-top: 10px;
        }

        .row {
            display: flex;
            gap: 8px;
        }

        #mic-btn {
            width: 50px;
            flex-shrink: 0;
            background: #f1f3f4;
            border: 1px solid #dadce0;
            font-size: 20px;
            border-radius: 8px;
        }

        #mic-btn.listening {
            background: #ea4335;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .play-btn {
            width: 50px;
            flex-shrink: 0;
            background: #fb8c00;
            color: white;
            font-size: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .action-btn {
            background: #1a73e8;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 0;
        }

        /* Result Section */
        .result {
            background: #e8f0fe;
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }

        .score-wrap {
            margin-bottom: 20px;
        }

        .score-val {
            font-size: 50px;
            font-weight: bold;
            display: block;
            line-height: 1;
            margin-bottom: 5px;
        }

        .score-msg {
            font-size: 18px;
            font-weight: bold;
        }

        /* Correct Answer Box (Highlighted) */
        .correct-box {
            background: #fff;
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .correct-label {
            color: #2e7d32;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        .correct-text {
            font-size: 22px;
            color: #1b5e20;
            font-weight: bold;
            word-break: keep-all;
        }

        /* Hidden Feedback Section */
        .feedback-box {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            text-align: left;
            font-size: 15px;
            border: 1px solid #ddd;
        }

        .feedback-label {
            color: #666;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
        }

        .audio-sm-btn {
            background: none;
            border: 1px solid #1a73e8;
            color: #1a73e8;
            padding: 4px 10px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }

        /* New Buttons */
        .big-btn {
            background: #e8f0fe;
            border: none;
            font-weight: bold;
            padding: 8px 16px;
            font-size: 15px;
        }

        .toggle-feedback-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 10px;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        #debug-console {
            background: #202124;
            color: #5bb974;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 10px;
            height: 80px;
            overflow-y: scroll;
            margin-top: 30px;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 1. Language Selection -->
        <div id="lang-screen">
            <h1>Global Together üåè</h1>
            <p style="color:#666; margin-bottom:30px;">Select Language</p>

            <div class="lang-group">
                <h3>üó£Ô∏è I speak (Native)</h3>
                <div class="radio-grid">
                    <div class="radio-item"><input type="radio" name="native" id="n-ko" value="ko"
                            onclick="updateStartConfig()"><label for="n-ko"><span class="flag">üá∞üá∑</span>Korean</label>
                    </div>
                    <div class="radio-item"><input type="radio" name="native" id="n-en" value="en"
                            onclick="updateStartConfig()"><label for="n-en"><span
                                class="flag">üá∫üá∏</span>English</label></div>
                    <div class="radio-item"><input type="radio" name="native" id="n-id" value="id"
                            onclick="updateStartConfig()"><label for="n-id"><span
                                class="flag">üáÆüá©</span>Indonesia</label>
                    </div>
                </div>
            </div>

            <div class="lang-group">
                <h3>üéì I want to learn (Target)</h3>
                <div class="radio-grid">
                    <div class="radio-item"><input type="radio" name="target" id="t-ko" value="ko"
                            onclick="updateStartConfig()"><label for="t-ko"><span class="flag">üá∞üá∑</span>Korean</label>
                    </div>
                    <div class="radio-item"><input type="radio" name="target" id="t-en" value="en"
                            onclick="updateStartConfig()"><label for="t-en"><span
                                class="flag">üá∫üá∏</span>English</label></div>
                    <div class="radio-item"><input type="radio" name="target" id="t-id" value="id"
                            onclick="updateStartConfig()"><label for="t-id"><span
                                class="flag">üáÆüá©</span>Indonesia</label>
                    </div>
                </div>
            </div>

            <button id="btn-start" onclick="startApp()" disabled>Start Learning</button>
        </div>

        <!-- 2. Category Selection (New) -->
        <div id="category-screen" style="display:none; text-align:center;">
            <button class="back-btn" onclick="location.reload()">‚Üê Language</button>
            <h1 id="cat-title">Select Situation</h1>
            <div id="cat-grid" class="category-grid">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- 3. Main App -->
        <div id="app-screen">
            <button class="back-btn" onclick="backToCategory()">‚Üê Back</button>
            <h1 id="app-title">Global Together</h1>

            <div class="card">
                <label id="lbl-select">1. Select</label>
                <div class="row">
                    <select id="question-select" onchange="onQuestionChange()"></select>
                    <button class="play-btn" onclick="playQuestion()">üîä</button>
                </div>

                <div class="highlight-box">
                    <h2 id="target-display" class="target-text"></h2>
                    <p id="native-display" class="native-text"></p>
                </div>

                <label id="lbl-input">2. Speak</label>
                <div class="row">
                    <input type="text" id="user-input" placeholder="...">
                    <button id="mic-btn" onclick="toggleSTT()">üé§</button>
                </div>

                <button id="btn-eval" class="action-btn" onclick="evaluateAnswer()">Check Pronunciation</button>
            </div>

            <div id="result-area" class="result"></div>

            <div id="debug-console">Debug Log:<br></div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let nativeLang = '';
        let targetLang = '';

        const LANG_META = {
            'ko': { name: 'Korean', flag: 'üá∞üá∑', tts: 'ko-KR' },
            'en': { name: 'English', flag: 'üá∫üá∏', tts: 'en-US' },
            'id': { name: 'Indonesian', flag: 'üáÆüá©', tts: 'id-ID' }
        };

        const logArea = document.getElementById('debug-console');
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${time}] ${msg}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        const UI_TEXT = {
            'ko': {
                title: "Ìï®Íªò Î∞∞Ïö∞Í∏∞", select: "ÌïôÏäµÌï† Î¨∏Ïû• ÏÑ†ÌÉù", input: "Îî∞Îùº ÎßêÌïòÍ∏∞", evalBtn: "Î∞úÏùå ÌôïÏù∏ÌïòÍ∏∞",
                placeholder: "ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî", listening: "Îì£Í≥† ÏûàÏñ¥Ïöî...",
                feedback: "AI Ï°∞Ïñ∏", correction: "Ï†ïÎãµ Î∞úÏùå", listen: "Îì£Í∏∞", error: "Ïò§Î•ò",
                why: "Ïôú ÌãÄÎ†∏ÎÇòÏöî?",
                msgPerfect: "ÏôÑÎ≤ΩÌï¥Ïöî! üéâ", msgGood: "Ï¢ãÏïÑÏöî! üëç", msgBad: "Îã§Ïãú Ìï¥Î≥¥ÏÑ∏Ïöî üí™",
                aiName: "AI ÏÑ†ÏÉùÎãò üßë‚Äçüè´"
            },
            'en': {
                title: "Learn Together", select: "Select Sentence", input: "Speak", evalBtn: "Check Pronunciation",
                placeholder: "Press mic to speak", listening: "Listening...",
                feedback: "AI Advice", correction: "Correct Answer", listen: "Listen", error: "Error",
                why: "Why is this wrong?",
                msgPerfect: "Perfect! üéâ", msgGood: "Good Job! üëç", msgBad: "Try Again üí™",
                aiName: "AI Tutor üßë‚Äçüè´"
            },
            'id': {
                title: "Belajar Bersama", select: "Pilih Kalimat", input: "Bicara", evalBtn: "Cek Pengucapan",
                placeholder: "Tekan mikrofon", listening: "Mendengarkan...",
                feedback: "Saran AI", correction: "Jawaban Benar", listen: "Dengar", error: "Error",
                why: "Kenapa salah?",
                msgPerfect: "Sempurna! üéâ", msgGood: "Bagus! üëç", msgBad: "Coba Lagi üí™",
                aiName: "Guru AI üßë‚Äçüè´"
            }
        };

        const QUESTIONS = [
            // 1. ÌïôÍµêÏóêÏÑú (School)
            { category: "School", ko: "ÏÑ†ÏÉùÎãò, ÏßàÎ¨∏ ÏûàÏñ¥Ïöî.", en: "Teacher, I have a question.", id: "Guru, saya ada pertanyaan.", difficulty: 1 },
            { category: "School", ko: "Îã§Ïãú ÌïúÎ≤à ÏÑ§Î™ÖÌï¥ Ï£ºÏÑ∏Ïöî.", en: "Please explain it again.", id: "Tolong jelaskan sekali lagi.", difficulty: 2 },
            { category: "School", ko: "ÌôîÏû•Ïã§ Îã§ÎÖÄÏôÄÎèÑ Îê†ÍπåÏöî?", en: "May I go to the bathroom?", id: "Bolehkah saya pergi ke toilet?", difficulty: 1 },
            { category: "School", ko: "ÏàôÏ†úÎäî Ïñ∏Ï†úÍπåÏßÄÏù∏Í∞ÄÏöî?", en: "When is the homework due?", id: "Kapan PR harus dikumpulkan?", difficulty: 2 },
            { category: "School", ko: "Ï±ÖÏùÑ ÎπåÎ¶¨Í≥† Ïã∂Ïñ¥Ïöî.", en: "I want to borrow a book.", id: "Saya ingin meminjam buku.", difficulty: 1 },
            { category: "School", ko: "ÌïúÍµ≠Ïñ¥Î•º Î∞∞Ïö∞Í≥† Ïã∂Ïñ¥Ïöî.", en: "I want to learn Korean.", id: "Saya ingin belajar bahasa Korea.", difficulty: 1 },
            { category: "School", ko: "Ï≤úÏ≤úÌûà ÎßêÌï¥ Ï£ºÏÑ∏Ïöî.", en: "Please speak slowly.", id: "Tolong bicara pelan-pelan.", difficulty: 1 },
            { category: "School", ko: "Ïù¥Í±∞ Î¨¥Ïä® ÎúªÏù¥ÏóêÏöî?", en: "What does this mean?", id: "Apa artinya ini?", difficulty: 1 },
            { category: "School", ko: "Í∞ôÏù¥ Ï†êÏã¨ Î®πÏùÑÎûòÏöî?", en: "Shall we have lunch together?", id: "Mau makan siang bersama?", difficulty: 2 },
            { category: "School", ko: "ÎÇ¥Ïùº ÌïôÍµêÏóêÏÑú Î¥êÏöî.", en: "See you at school tomorrow.", id: "Sampai jumpa di sekolah besok.", difficulty: 1 },

            // 2. Ïó¨ÌñâÏóêÏÑú (Travel) - ÏàôÏÜå Î∞è Í¥ÄÍ¥ë
            { category: "Travel", ko: "ÏòàÏïΩ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.", en: "I have a reservation.", id: "Saya sudah reservasi.", difficulty: 1 },
            { category: "Travel", ko: "Îπà Î∞© ÏûàÎÇòÏöî?", en: "Do you have a vacant room?", id: "Apakah ada kamar kosong?", difficulty: 1 },
            { category: "Travel", ko: "Ï°∞ÏãùÏùÄ Î™á ÏãúÏù∏Í∞ÄÏöî?", en: "What time is breakfast?", id: "Jam berapa sarapan?", difficulty: 1 },
            { category: "Travel", ko: "ÏôÄÏù¥ÌååÏù¥ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≠êÏòàÏöî?", en: "What is the WiFi password?", id: "Apa kata sandi WiFi-nya?", difficulty: 2 },
            { category: "Travel", ko: "ÏàòÍ±¥ Ï¢Ä Îçî Ï£ºÏãúÍ≤†Ïñ¥Ïöî?", en: "Can I have more towels?", id: "Bisakah saya minta handuk lagi?", difficulty: 2 },
            { category: "Travel", ko: "ÏßêÏùÑ Îß°Í≤®ÎèÑ Îê†ÍπåÏöî?", en: "Can I leave my luggage?", id: "Bolehkah saya menitipkan barang?", difficulty: 2 },
            { category: "Travel", ko: "Ïó¨Í∏∞ÏÑú ÏÇ¨ÏßÑ Ï¢Ä Ï∞çÏñ¥Ï£ºÏÑ∏Ïöî.", en: "Please take a picture here.", id: "Tolong ambilkan foto di sini.", difficulty: 1 },
            { category: "Travel", ko: "ÏûÖÏû•Î£åÎäî ÏñºÎßàÏòàÏöî?", en: "How much is the admission fee?", id: "Berapa harga tiket masuknya?", difficulty: 2 },
            { category: "Travel", ko: "Í∑ºÏ≤òÏóê Í¥ÄÍ¥ëÏßÄÍ∞Ä ÏûàÎÇòÏöî?", en: "Is there a tourist spot nearby?", id: "Apakah ada tempat wisata di dekat sini?", difficulty: 2 },
            { category: "Travel", ko: "ÌÉùÏãúÎ•º Î∂àÎü¨Ï£ºÏÑ∏Ïöî.", en: "Please call a taxi.", id: "Tolong panggilkan taksi.", difficulty: 1 },

            // 6. Í≥µÌï≠ÏóêÏÑú (Airport) - NEW
            { category: "Airport", ko: "Ï≤¥ÌÅ¨Ïù∏ Î∂ÄÌÉÅÌï©ÎãàÎã§.", en: "Check-in, please.", id: "Tolong check-in.", difficulty: 1 },
            { category: "Airport", ko: "Ïó¨Í∂åÏùÑ Î≥¥Ïó¨Ï£ºÏÑ∏Ïöî.", en: "Please show me your passport.", id: "Tolong tunjukkan paspor Anda.", difficulty: 1 },
            { category: "Airport", ko: "Ï∞ΩÍ∞Ä Ï™Ω Ï¢åÏÑùÏúºÎ°ú Ï£ºÏÑ∏Ïöî.", en: "Window seat, please.", id: "Tolong kursi dekat jendela.", difficulty: 2 },
            { category: "Airport", ko: "ÏàòÌïòÎ¨ºÏùÄ Ïñ¥ÎîîÏÑú Ï∞æÎÇòÏöî?", en: "Where can I claim my baggage?", id: "Di mana saya bisa mengambil bagasi?", difficulty: 2 },
            { category: "Airport", ko: "ÎπÑÌñâÍ∏∞Í∞Ä ÏßÄÏó∞ÎêòÏóàÎÇòÏöî?", en: "Is the flight delayed?", id: "Apakah penerbangannya ditunda?", difficulty: 2 },
            { category: "Airport", ko: "ÌÉëÏäπ Í≤åÏù¥Ìä∏Îäî Ïñ¥ÎîîÏòàÏöî?", en: "Where is the boarding gate?", id: "Di mana gerbang keberangkatannya?", difficulty: 2 },
            { category: "Airport", ko: "ÌôòÏ†ÑÏùÑ ÌïòÍ≥† Ïã∂Ïñ¥Ïöî.", en: "I want to exchange money.", id: "Saya ingin menukar uang.", difficulty: 2 },
            { category: "Airport", ko: "Î©¥ÏÑ∏Ï†êÏùÄ Ïñ¥ÎîîÏóê ÏûàÎÇòÏöî?", en: "Where is the duty-free shop?", id: "Di mana toko bebas bea?", difficulty: 2 },
            { category: "Airport", ko: "Î¨º Ìïú Ïûî Ï£ºÏÑ∏Ïöî.", en: "Can I have some water?", id: "Bisa minta air?", difficulty: 1 },
            { category: "Airport", ko: "ÎèÑÏ∞© ÏãúÍ∞ÑÏù¥ Ïñ∏Ï†úÏòàÏöî?", en: "When is the arrival time?", id: "Kapan waktu kedatangannya?", difficulty: 2 },

            // 3. Î≥ëÏõêÏóêÏÑú (Hospital)
            { category: "Hospital", ko: "Î®∏Î¶¨Í∞Ä ÏïÑÌååÏöî.", en: "I have a headache.", id: "Sakit kepala.", difficulty: 1 },
            { category: "Hospital", ko: "Ïó¥Ïù¥ ÎÇòÏöî.", en: "I have a fever.", id: "Saya demam.", difficulty: 1 },
            { category: "Hospital", ko: "Î∞∞Í∞Ä ÎÑàÎ¨¥ ÏïÑÌååÏöî.", en: "My stomach hurts so much.", id: "Perut saya sakit sekali.", difficulty: 2 },
            { category: "Hospital", ko: "ÏùòÏÇ¨ ÏÑ†ÏÉùÎãòÏùÑ Î≥¥Í≥† Ïã∂Ïñ¥Ïöî.", en: "I want to see a doctor.", id: "Saya ingin bertemu dokter.", difficulty: 2 },
            { category: "Hospital", ko: "ÏïΩÍµ≠ÏùÄ Ïñ¥ÎîîÏóê ÏûàÎÇòÏöî?", en: "Where is the pharmacy?", id: "Di mana apotek?", difficulty: 1 },
            { category: "Hospital", ko: "Í∞êÍ∏∞Ïóê Í±∏Î†∏Ïñ¥Ïöî.", en: "I caught a cold.", id: "Saya masuk angin.", difficulty: 1 },
            { category: "Hospital", ko: "Ïñ∏Ï†úÎ∂ÄÌÑ∞ ÏïÑÌå†ÎÇòÏöî?", en: "Since when have you been sick?", id: "Sejak kapan kamu sakit?", difficulty: 2 },
            { category: "Hospital", ko: "Ïù¥ ÏïΩÏùÑ ÎìúÏÑ∏Ïöî.", en: "Please take this medicine.", id: "Silakan minum obat ini.", difficulty: 1 },
            { category: "Hospital", ko: "ÏùëÍ∏âÏã§Î°ú Í∞ÄÏ£ºÏÑ∏Ïöî.", en: "Please go to the emergency room.", id: "Tolong ke ruang gawat darurat.", difficulty: 3 },
            { category: "Hospital", ko: "Ìëπ Ïâ¨ÏÑ∏Ïöî.", en: "Get some rest.", id: "Istirahatlah yang cukup.", difficulty: 1 },

            // 4. ÏãúÏû•ÏóêÏÑú (Market)
            { category: "Market", ko: "Ïù¥Í±∞ ÏñºÎßàÏòàÏöî?", en: "How much is this?", id: "Berapa harganya?", difficulty: 1 },
            { category: "Market", ko: "ÎÑàÎ¨¥ ÎπÑÏã∏Ïöî.", en: "It's too expensive.", id: "Terlalu mahal.", difficulty: 1 },
            { category: "Market", ko: "ÍπéÏïÑÏ£ºÏÑ∏Ïöî.", en: "Please give me a discount.", id: "Tolong berikan diskon.", difficulty: 2 },
            { category: "Market", ko: "Ïã†ÏÑ†Ìïú Í≥ºÏùº ÏûàÎÇòÏöî?", en: "Do you have fresh fruit?", id: "Apakah ada buah segar?", difficulty: 1 },
            { category: "Market", ko: "Ïù¥Í≤É Ï¢Ä Î≥¥Ïó¨Ï£ºÏÑ∏Ïöî.", en: "Please show me this.", id: "Tolong tunjukkan ini.", difficulty: 1 },
            { category: "Market", ko: "Î¥âÌà¨ Ï£ºÏÑ∏Ïöî.", en: "Please give me a bag.", id: "Tolong beri saya kantong.", difficulty: 1 },
            { category: "Market", ko: "Ïπ¥ÎìúÎ°ú Í≥ÑÏÇ∞ÎêòÎÇòÏöî?", en: "Can I pay by card?", id: "Bisa bayar pakai kartu?", difficulty: 2 },
            { category: "Market", ko: "Îã§Î•∏ ÏÉâÍπî ÏûàÎÇòÏöî?", en: "Do you have other colors?", id: "Apakah ada warna lain?", difficulty: 1 },
            { category: "Market", ko: "ÏûÖÏñ¥Î¥êÎèÑ ÎêòÎÇòÏöî?", en: "Can I try this on?", id: "Boleh saya coba ini?", difficulty: 1 },
            { category: "Market", ko: "Îòê Ïò¨Í≤åÏöî.", en: "I will come again.", id: "Saya akan datang lagi.", difficulty: 1 },

            // 5. ÏãùÎãπÏóêÏÑú (Restaurant)
            { category: "Restaurant", ko: "Î©îÎâ¥Ìåê Ï£ºÏÑ∏Ïöî.", en: "Please give me the menu.", id: "Tolong berikan menunya.", difficulty: 1 },
            { category: "Restaurant", ko: "Ï£ºÎ¨∏ÌïòÏãúÍ≤†Ïñ¥Ïöî?", en: "Are you ready to order?", id: "Apakah Anda siap memesan?", difficulty: 2 },
            { category: "Restaurant", ko: "Î¨º Ï¢Ä Ï£ºÏÑ∏Ïöî.", en: "Please give me some water.", id: "Tolong minta air.", difficulty: 1 },
            { category: "Restaurant", ko: "Ïù¥Í±∞ Ïïà Îß§Ïö¥Í∞ÄÏöî?", en: "Is this not spicy?", id: "Apakah ini tidak pedas?", difficulty: 2 },
            { category: "Restaurant", ko: "Ï∂îÏ≤úÌï¥ Ï£ºÏÑ∏Ïöî.", en: "Please recommend something.", id: "Tolong rekomendasikan sesuatu.", difficulty: 2 },
            { category: "Restaurant", ko: "Í≥ÑÏÇ∞ÏÑú Ï£ºÏÑ∏Ïöî.", en: "Please give me the bill.", id: "Tolong minta tagihannya.", difficulty: 1 },
            { category: "Restaurant", ko: "Ï†ïÎßê ÎßõÏûàÏñ¥Ïöî.", en: "It is really delicious.", id: "Ini enak sekali.", difficulty: 1 },
            { category: "Restaurant", ko: "Ìè¨Ïû•Ìï¥ Ï£ºÏÑ∏Ïöî.", en: "Please wrap this up.", id: "Tolong dibungkus.", difficulty: 2 },
            { category: "Restaurant", ko: "ÏòàÏïΩ ÌñàÎÇòÏöî?", en: "Did you make a reservation?", id: "Apakah Anda sudah reservasi?", difficulty: 2 },
            { category: "Restaurant", ko: "Ïûò Î®πÏóàÏäµÎãàÎã§.", en: "Thank you for the meal.", id: "Terima kasih atas makanannya.", difficulty: 1 }
        ];

        const CATEGORY_META = {
            'School': { icon: 'üè´', ko: 'ÌïôÍµêÏóêÏÑú', en: 'At School', id: 'Di Sekolah' },
            'Travel': { icon: '‚úàÔ∏è', ko: 'Ïó¨ÌñâÍ∞ÄÏÑú', en: 'Travel', id: 'Saat Traveling' },
            'Airport': { icon: 'üõ´', ko: 'Í≥µÌï≠ÏóêÏÑú', en: 'Airport', id: 'Di Bandara' },
            'Hospital': { icon: 'üè•', ko: 'Î≥ëÏõêÏóêÏÑú', en: 'Hospital', id: 'Di Rumah Sakit' },
            'Market': { icon: 'üõí', ko: 'ÏãúÏû•ÏóêÏÑú', en: 'Market', id: 'Di Pasar' },
            'Restaurant': { icon: 'üçΩÔ∏è', ko: 'ÏãùÎãπÏóêÏÑú', en: 'Restaurant', id: 'Di Restoran' }
        };

        function updateStartConfig() {
            const n = document.querySelector('input[name="native"]:checked');
            const t = document.querySelector('input[name="target"]:checked');
            const btn = document.getElementById('btn-start');
            if (n && t) {
                if (n.value === t.value) {
                    btn.innerText = "Select different languages";
                    btn.disabled = true;
                } else {
                    btn.innerText = `Start Learning (${LANG_META[t.value].flag})`;
                    btn.disabled = false;
                }
            }
        }

        function startApp() {
            nativeLang = document.querySelector('input[name="native"]:checked').value;
            targetLang = document.querySelector('input[name="target"]:checked').value;

            document.getElementById('lang-screen').style.display = 'none';
            document.getElementById('category-screen').style.display = 'block'; // Î®ºÏ†Ä Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôîÎ©¥ ÌëúÏãú

            renderCategories();
        }

        function renderCategories() {
            const grid = document.getElementById('cat-grid');
            grid.innerHTML = '';

            // 6Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨
            const cats = ['School', 'Airport', 'Travel', 'Hospital', 'Market', 'Restaurant'];

            cats.forEach(cat => {
                const meta = CATEGORY_META[cat];
                const label = meta[nativeLang] || meta['en']; // ÏÇ¨Ïö©Ïûê Ïñ∏Ïñ¥Î°ú ÎùºÎ≤® ÌëúÏãú

                const btn = document.createElement('div');
                btn.className = 'cat-card';
                btn.onclick = () => selectCategory(cat);
                btn.innerHTML = `
                    <div class="cat-icon">${meta.icon}</div>
                    <div class="cat-label">${label}</div>
                `;
                grid.appendChild(btn);
            });

            // Ï†úÎ™© ÏÑ§Ï†ï
            const t = UI_TEXT[nativeLang] || UI_TEXT['en'];
            const targetName = LANG_META[targetLang].name;
            document.getElementById('cat-title').innerText = `${t.title} - ${targetName}`;
        }

        function backToCategory() {
            document.getElementById('app-screen').style.display = 'none';
            document.getElementById('category-screen').style.display = 'block';
        }

        let currentCategoryQuestions = [];

        function selectCategory(cat) {
            document.getElementById('category-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';

            // Filter questions
            currentCategoryQuestions = QUESTIONS.filter(q => q.category === cat);

            const t = UI_TEXT[nativeLang] || UI_TEXT['en'];
            const meta = CATEGORY_META[cat];
            const catLabel = meta[nativeLang] || meta['en'];

            document.getElementById('app-title').innerText = `${meta.icon} ${catLabel}`;

            const select = document.getElementById('question-select');
            select.innerHTML = '';

            currentCategoryQuestions.forEach((q, idx) => {
                const targetText = q[targetLang];
                const nativeText = q[nativeLang];
                const option = document.createElement('option');
                option.value = idx;
                option.text = `[Lev${q.difficulty}] ${targetText} (${nativeText})`;
                select.appendChild(option);
            });

            onQuestionChange();
        }

        function onQuestionChange() {
            const idx = document.getElementById('question-select').value;
            if (idx === null || idx === undefined || !currentCategoryQuestions[idx]) return;

            const q = currentCategoryQuestions[idx];
            document.getElementById('target-display').innerText = q[targetLang];
            document.getElementById('native-display').innerText = q[nativeLang];
            document.getElementById('user-input').value = '';
            document.getElementById('result-area').style.display = 'none';
        }

        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                const voices = window.speechSynthesis.getVoices();
                log(`Voices loaded: ${voices.length}`);
                // ÌïúÍµ≠Ïñ¥ ÏùåÏÑ± Î™©Î°ù Ï∂úÎ†• (ÎîîÎ≤ÑÍπÖÏö©)
                const koVoices = voices.filter(v => v.lang.includes('ko'));
                if (koVoices.length > 0) {
                    log(`üá∞üá∑ KO Voices: ${koVoices.map(v => v.name).join(', ')}`);
                } else {
                    log("‚ö†Ô∏è No Korean voices found!");
                }
            };
        }

        // --- Improved Speak Function ---
        function playQuestion() {
            const text = document.getElementById('target-display').innerText;
            speak(text, LANG_META[targetLang].tts);
        }

        function speak(text, lang) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();

            const cleanText = text.replace(/[\n\r]/g, ' ').trim();
            if (!cleanText) return;

            const u = new SpeechSynthesisUtterance(cleanText);
            u.lang = lang || 'en-US';
            u.rate = 1.0; // ÏÜçÎèÑ Ï†ïÍ∑úÌôî

            const voices = window.speechSynthesis.getVoices();
            const langCode = u.lang.split('-')[0]; // 'ko', 'en'

            let targetVoice = null;

            if (langCode === 'ko') {
                // ÌïúÍµ≠Ïñ¥: Íµ¨Í∏Ä(Ïò®ÎùºÏù∏) -> Íµ¨Í∏Ä(Ïò§ÌîÑÎùºÏù∏) -> Í∏∞ÌÉÄ ÏàúÏúºÎ°ú Í∞ïÎ†•ÌïòÍ≤å Ï∞æÍ∏∞
                targetVoice = voices.find(v => v.name.includes('Google ÌïúÍµ≠Ïñ¥')) ||
                    voices.find(v => v.name.includes('Google Korean')) ||
                    voices.find(v => v.lang === 'ko-KR' && v.name.includes('Google')) ||
                    voices.find(v => v.name.includes('Korean')) || // ÏùºÎ∞ò Korean
                    voices.find(v => v.lang.includes('ko'));      // ÏµúÌõÑÏùò ÏàòÎã®
            } else if (langCode === 'en') {
                targetVoice = voices.find(v => v.name.includes('Google US')) ||
                    voices.find(v => v.name.includes('Google')) ||
                    voices.filter(v => v.lang.startsWith('en'))[0];
            } else if (langCode === 'id') {
                targetVoice = voices.find(v => v.name.includes('Indonesia')) ||
                    voices.filter(v => v.lang.startsWith('id'))[0];
            }

            if (targetVoice) {
                u.voice = targetVoice;
                log(`üîä Speaking with: ${targetVoice.name}`);
            } else {
                log(`‚ö†Ô∏è Voice not found for ${lang}, using default.`);
            }

            window.speechSynthesis.speak(u);
        }

        // --- STT ---
        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onstart = () => {
                document.getElementById('mic-btn').className = 'listening';
                if (nativeLang) document.getElementById('user-input').placeholder = UI_TEXT[nativeLang].listening;
            };
            recognition.onend = () => {
                document.getElementById('mic-btn').className = '';
                if (nativeLang) document.getElementById('user-input').placeholder = UI_TEXT[nativeLang].placeholder;
            };
            recognition.onresult = (e) => {
                document.getElementById('user-input').value = e.results[0][0].transcript;
            };
        }
        function toggleSTT() {
            if (recognition && targetLang) {
                recognition.lang = LANG_META[targetLang].tts;
                recognition.start();
            } else alert("Microphone not supported");
        }

        // --- Evaluation ---
        async function evaluateAnswer() {
            const input = document.getElementById('user-input').value;
            if (!input) return;

            const resultArea = document.getElementById('result-area');
            resultArea.style.display = 'block';
            resultArea.innerHTML = '<div>Analyzing... üß†</div>';

            const idx = document.getElementById('question-select').value;
            const q = currentCategoryQuestions[idx];
            if (!q) return;

            const t = UI_TEXT[nativeLang] || UI_TEXT['en'];

            try {
                const response = await fetch(`${API_BASE}/koto-ai/api/v1/evaluate`, {
                    method: 'POST', text: input,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_text: input, expected_pattern: q[targetLang],
                        context: { target_lang: targetLang, native_lang: nativeLang }
                    })
                });
                const data = await response.json();

                const score = (data.score === undefined || data.score === null) ? 0 : Number(data.score);

                // ÌîÑÎ°†Ìä∏ÏóîÎìú Î∞©Ïñ¥: ÌîºÎìúÎ∞±Ïù¥ ÏóÜÍ±∞ÎÇò ... Ïù¥Î©¥ Í∏∞Î≥∏ Î©îÏãúÏßÄ Ï∂úÎ†•
                let feedbackText = data.feedback;
                if (!feedbackText || feedbackText.trim() === "..." || feedbackText.trim() === "") {
                    // Fallback Text Localization
                    if (nativeLang === 'ko') feedbackText = "AI ÌîºÎìúÎ∞±Ïù¥ ÏóÜÏäµÎãàÎã§.";
                    else if (nativeLang === 'id') feedbackText = "Tidak ada respons dari AI."; // Ïù∏ÎãàÏñ¥ Fix
                    else feedbackText = "No feedback received.";
                }

                let color = '#f44336';
                let msg = t.msgBad; // Default: Bad (Localized)

                if (score >= 90) {
                    color = '#4CAF50';
                    msg = t.msgPerfect;
                } else if (score >= 60) {
                    color = '#FF9800';
                    msg = t.msgGood;
                }

                const esc = (s) => s ? s.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ') : '';

                const showCorrection = score < 90;
                const correctText = data.corrected || q[targetLang];
                const feedbackTts = LANG_META[nativeLang].tts;
                const correctTts = LANG_META[targetLang].tts;

                // --- UI Rendering ---
                let html = `
                    <div class="score-wrap">
                        <span class="score-val" style="color:${color}">${score}</span>
                        <span class="score-msg" style="color:${color}">${msg}</span>
                    </div>
                `;

                // 1. Correct Answer
                if (showCorrection) {
                    html += `
                        <div class="correct-box" style="border-color:${color}">
                            <span class="correct-label">üì¢ ${t.correction}</span>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span class="correct-text" style="color:${color}">${correctText}</span>
                                <button class="audio-sm-btn big-btn" onclick="speak('${esc(correctText)}', '${correctTts}')">üîä ${t.listen}</button>
                            </div>
                        </div>
                    `;
                }

                // 2. AI Feedback (Hidden)
                html += `
                    <div style="text-align:center; margin-top:15px;">
                        <button class="toggle-feedback-btn" onclick="toggleFeedback()">
                            üí° ${t.why}
                        </button>
                    </div>
                    
                    <div id="ai-feedback-box" class="feedback-box" style="display:none;">
                        <span class="feedback-label">${t.aiName}</span>
                        <div style="line-height:1.5;">
                             ${feedbackText}
                             <button class="audio-sm-btn" style="border:none;" onclick="speak('${esc(feedbackText)}', '${feedbackTts}')">üîä</button>
                        </div>
                    </div>
                `;

                resultArea.innerHTML = html;

            } catch (e) {
                resultArea.innerHTML = `Error: ${e.message}`;
            }
        }

        function toggleFeedback() {
            const box = document.getElementById('ai-feedback-box');
            box.style.display = (box.style.display === 'none') ? 'block' : 'none';
        }
    </script>
</body>

</html>